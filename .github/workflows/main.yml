on: [push, pull_request]

name: Continuous integration

jobs:
  check:
    name: Check and build (stable)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
      - uses: actions-rs/cargo@v1
        with:
          command: build

  test:
    name: Test suite (stable)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
      - uses: actions-rs/cargo@v1
        with:
          command: test

  demos:
    name: Demos (nightly)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly-2022-01-15
          override: true
      - uses: actions-rs/cargo@v1
        with:
          command: build
          args: --release
      - name: Checkout nix-rust/nix
        uses: actions/checkout@v2
        with:
          repository: nix-rust/nix
          ref: afba7c5a33dd4fd62b047e64089487cf822ccec2 # 0.23.1
          path: nix
      - name: Checkout rust-lang/regex
        uses: actions/checkout@v2
        with:
          repository: rust-lang/regex
          ref: f2dc1b788f773a49f1b6633a6302054978344452 # 1.5.4
          path: regex
      - name: Checkout alexcrichton/curl-rust
        uses: actions/checkout@v2
        with:
          repository: alexcrichton/curl-rust
          ref: 3e35a00d059c96e8010e7a13d1cdf848baba6575 # 0.4.42
          path: curl
      - name: rustdoc.json nix
        uses: actions-rs/cargo@v1
        with:
          command: doc
          args: --manifest-path nix/Cargo.toml
        env:
          RUSTDOCFLAGS: -Zunstable-options --output-format=json
      - name: rustdoc.json regex
        uses: actions-rs/cargo@v1
        with:
          command: doc
          args: --manifest-path regex/Cargo.toml
        env:
          RUSTDOCFLAGS: -Zunstable-options --output-format=json
      - name: rustdoc.json curl
        uses: actions-rs/cargo@v1
        with:
          command: doc
          args: --manifest-path curl/Cargo.toml
        env:
          RUSTDOCFLAGS: -Zunstable-options --output-format=json
      - name: rd.html nix regex curl ...
        uses: actions-rs/cargo@v1
        with:
          command: run
          args: |
            --release --
            --output output/
            nix/target/doc/nix.json
            nix/target/doc/libc.json
            regex/target/doc/regex.json
            regex/target/doc/memchr.json
            curl/target/doc/curl.json
            curl/target/doc/curl-sys.json
      - name: Deploy ðŸš€
        uses: JamesIves/github-pages-deploy-action@v4.2.2
        with:
          branch: gh-pages
          folder: output/
